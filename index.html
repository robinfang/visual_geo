<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中国化肥企业产能分布与空间分析系统</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Microsoft YaHei', sans-serif; overflow: hidden; }
        
        /* 布局容器 */
        #container { display: flex; height: 100%; }
        
        /* 左侧控制面板 */
        #sidebar {
            width: 320px;
            background: #f8f9fa;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
        }

        /* 地图容器 */
        #map { flex: 1; height: 100%; }

        /* 样式组件 */
        h2 { margin-top: 0; font-size: 18px; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        h3 { font-size: 16px; margin: 10px 0 5px; color: #555; }
        
        .card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        
        .stat-item { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .stat-label { color: #666; font-size: 14px; }
        .stat-value { font-weight: bold; color: #007bff; font-size: 16px; }
        
        label { display: block; margin-bottom: 5px; font-size: 14px; }
        select, input[type=range] { width: 100%; margin-bottom: 10px; }
        
        button {
            width: 100%;
            padding: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        button:hover { background-color: #0056b3; }
        button.active { background-color: #dc3545; } /* 激活状态变为红色 */

        .loading-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            font-size: 20px; color: #333;
        }
    </style>
</head>
<body>

<div class="loading-overlay" id="loader">系统初始化中，正在下载地理数据...</div>

<div id="container">
    <!-- 侧边栏 -->
    <div id="sidebar">
        <h2>化肥产能分析看板</h2>
        
        <!-- 模式 1: 区域统计 -->
        <div class="card">
            <h3>按行政区统计</h3>
            <p style="font-size:12px; color:#999;">(基于前端几何计算自动归属)</p>
            <label>选择省份:</label>
            <select id="provinceSelect">
                <option value="all">全部区域</option>
                <!-- 动态填充 -->
            </select>
        </div>

        <!-- 模式 2: 空间圈选 -->
        <div class="card">
            <h3>空间圈选分析</h3>
            <button id="btnCircleMode">开启圈选模式 (点击地图)</button>
            <div id="radiusControl" style="display:none; margin-top:10px;">
                <label>搜索半径: <span id="radiusVal">50</span> km</label>
                <input type="range" id="radiusSlider" min="10" max="200" value="50" step="10">
            </div>
        </div>

        <!-- 统计结果 -->
        <div class="card">
            <h3>当前视图统计</h3>
            <div class="stat-item">
                <span class="stat-label">企业数量:</span>
                <span class="stat-value" id="statCount">0</span> 家
            </div>
            <div class="stat-item">
                <span class="stat-label">总产能:</span>
                <span class="stat-value" id="statCapacity">0</span> 万吨
            </div>
            <div class="stat-item">
                <span class="stat-label">平均产能:</span>
                <span class="stat-value" id="statAvg">0</span> 万吨
            </div>
        </div>
        
        <div style="font-size:12px; color:#999; margin-top:auto;">
            数据说明：本系统演示数据为虚构。<br>
            技术栈：Leaflet + Turf.js
        </div>
    </div>

    <!-- 地图 -->
    <div id="map"></div>
</div>

<!-- 引入库文件 -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

<script>
    // ============================================================
    // 1. 地图初始化 (使用高德底图，替代 ChineseTmsProviders 插件)
    // ============================================================
    const map = L.map('map', {
        center: [38.0428, 114.5149], // 石家庄中心
        zoom: 7,
        minZoom: 5
    });

    // 高德地图图层 (标准瓦片)
    L.tileLayer('https://webrd02.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
        attribution: '&copy; 高德地图'
    }).addTo(map);

    // 全局变量
    let allEnterprises = []; // 存储所有企业数据 (GeoJSON FeatureCollection)
    let provincePolygons = null; // 存储省份边界数据
    let geoJsonLayer = null; // 地图上的点图层
    let circleLayer = null; // 地图上的圆圈图层
    let isCircleMode = false; // 是否处于圈选模式
    let currentCircleCenter = null; // 当前圆心

    // ============================================================
    // 2. 数据准备与前端几何计算
    // ============================================================
    
    // 2.1 生成虚构数据 (以河北为主，包含少量周边省份以测试边界计算)
    function generateMockData() {
        const features = [];
        const centerLat = 38.0;
        const centerLng = 115.0;
        
        for (let i = 0; i < 200; i++) {
            // 在中心点附近随机生成点
            const lat = centerLat + (Math.random() - 0.5) * 5; // 纬度范围
            const lng = centerLng + (Math.random() - 0.5) * 6; // 经度范围
            const capacity = Math.floor(Math.random() * 500) + 50; // 产能 50-550 万吨

            features.push({
                type: "Feature",
                geometry: {
                    type: "Point",
                    coordinates: [lng, lat] // GeoJSON 格式是 [经度, 纬度]
                },
                properties: {
                    id: i,
                    name: `化肥厂 #${i+1}`,
                    capacity: capacity,
                    province: "未知" // 初始为空，稍后计算
                }
            });
        }
        return { type: "FeatureCollection", features: features };
    }

    // 2.2 核心功能：前端几何计算归属省份
    function calculateProvinces(pointsData, provincesGeoJSON) {
        console.log("开始进行前端几何计算...");
        
        // 遍历每一个点
        pointsData.features.forEach(point => {
            // 遍历每一个省份多边形
            for (let i = 0; i < provincesGeoJSON.features.length; i++) {
                const province = provincesGeoJSON.features[i];
                // Turf.js 判断点是否在多边形内
                if (turf.booleanPointInPolygon(point, province)) {
                    // 如果在，写入属性
                    point.properties.province = province.properties.name;
                    break; // 找到归属后停止内层循环
                }
            }
        });
        console.log("计算完成。");
    }

    // ============================================================
    // 3. 业务逻辑与 UI 交互
    // ============================================================

    // 初始化加载
    async function initApp() {
        try {
            // 下载中国省份边界数据 (阿里云 DataV 接口)
            const response = await fetch('https://geo.datav.aliyun.com/areas_v3/bound/100000_full.json');
            provincePolygons = await response.json();

            // 生成模拟点位
            const rawData = generateMockData();

            // 【核心步骤】执行几何计算，把点归类到省份
            calculateProvinces(rawData, provincePolygons);
            allEnterprises = rawData.features;

            // 填充下拉框
            populateProvinceSelect();

            // 渲染所有点
            renderPoints(allEnterprises);
            
            // 初始统计
            updateStats(allEnterprises);

            // 移除 Loading
            document.getElementById('loader').style.display = 'none';

        } catch (error) {
            alert("数据加载失败，请检查网络");
            console.error(error);
        }
    }

    // 填充省份下拉框 (基于实际数据中存在的省份)
    function populateProvinceSelect() {
        const select = document.getElementById('provinceSelect');
        // 提取所有点的省份属性，去重
        const provinces = [...new Set(allEnterprises.map(f => f.properties.province))].filter(p => p !== "未知");
        
        provinces.sort().forEach(p => {
            const option = document.createElement('option');
            option.value = p;
            option.innerText = p;
            if(p.includes("河北")) option.selected = true; // 默认选中河北
            select.appendChild(option);
        });

        // 触发一次默认筛选
        filterByProvince(); 
    }

    // 渲染点位到地图
    function renderPoints(features) {
        if (geoJsonLayer) map.removeLayer(geoJsonLayer);

        geoJsonLayer = L.geoJSON(features, {
            pointToLayer: function (feature, latlng) {
                // 根据产能大小调整圆点大小和颜色
                const size = Math.sqrt(feature.properties.capacity) / 2; 
                return L.circleMarker(latlng, {
                    radius: size < 4 ? 4 : size,
                    fillColor: "#ff7800",
                    color: "#000",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                });
            },
            onEachFeature: function (feature, layer) {
                layer.bindPopup(`
                    <b>${feature.properties.name}</b><br>
                    所属省份: ${feature.properties.province}<br>
                    年产能: ${feature.properties.capacity} 万吨
                `);
            }
        }).addTo(map);
    }

    // 更新统计面板
    function updateStats(features) {
        const count = features.length;
        const totalCap = features.reduce((sum, f) => sum + f.properties.capacity, 0);
        const avgCap = count > 0 ? (totalCap / count).toFixed(1) : 0;

        document.getElementById('statCount').innerText = count;
        document.getElementById('statCapacity').innerText = totalCap;
        document.getElementById('statAvg').innerText = avgCap;
    }

    // 逻辑：按省份筛选
    function filterByProvince() {
        // 如果正在圈选模式，先关闭
        if(isCircleMode) toggleCircleMode();

        const selectedProv = document.getElementById('provinceSelect').value;
        
        let filtered = [];
        if (selectedProv === 'all') {
            filtered = allEnterprises;
        } else {
            filtered = allEnterprises.filter(f => f.properties.province.includes(selectedProv));
        }

        renderPoints(filtered);
        updateStats(filtered);

        // 自动缩放到筛选结果范围
        if (filtered.length > 0 && geoJsonLayer) {
            map.fitBounds(geoJsonLayer.getBounds());
        }
    }

    // 逻辑：圈选计算
    function performCircleAnalysis(latlng, radiusKm) {
        // 1. 在地图上画圆 (Leaflet 的 Circle 半径单位是米)
        if (circleLayer) map.removeLayer(circleLayer);
        circleLayer = L.circle(latlng, {
            radius: radiusKm * 1000,
            color: 'red',
            fillColor: '#f03',
            fillOpacity: 0.1
        }).addTo(map);

        // 2. 使用 Turf 计算圆内的点
        // Turf 需要 GeoJSON Point [lng, lat]
        const centerPoint = turf.point([latlng.lng, latlng.lat]);
        
        // 筛选
        const filtered = allEnterprises.filter(f => {
            const targetPoint = turf.point(f.geometry.coordinates);
            const distance = turf.distance(centerPoint, targetPoint, {units: 'kilometers'});
            return distance <= radiusKm;
        });

        // 3. 更新界面
        renderPoints(filtered); // 只显示圈内的点
        updateStats(filtered);
    }

    // ============================================================
    // 4. 事件监听
    // ============================================================

    // 省份下拉框变化
    document.getElementById('provinceSelect').addEventListener('change', filterByProvince);

    // 圈选模式开关
    const btnCircle = document.getElementById('btnCircleMode');
    const radiusControl = document.getElementById('radiusControl');

    function toggleCircleMode() {
        isCircleMode = !isCircleMode;
        if (isCircleMode) {
            btnCircle.innerText = "退出圈选模式";
            btnCircle.classList.add('active');
            radiusControl.style.display = 'block';
            map.getContainer().style.cursor = 'crosshair'; // 改变鼠标样式
            document.getElementById('provinceSelect').disabled = true; // 禁用省份选择
        } else {
            btnCircle.innerText = "开启圈选模式 (点击地图)";
            btnCircle.classList.remove('active');
            radiusControl.style.display = 'none';
            map.getContainer().style.cursor = '';
            if (circleLayer) map.removeLayer(circleLayer);
            document.getElementById('provinceSelect').disabled = false;
            // 恢复省份筛选视图
            filterByProvince();
        }
    }

    btnCircle.addEventListener('click', toggleCircleMode);

    // 地图点击事件
    map.on('click', function(e) {
        if (!isCircleMode) return;
        
        currentCircleCenter = e.latlng;
        const radius = document.getElementById('radiusSlider').value;
        performCircleAnalysis(currentCircleCenter, radius);
    });

    // 半径滑块拖动事件
    document.getElementById('radiusSlider').addEventListener('input', function(e) {
        const radius = e.target.value;
        document.getElementById('radiusVal').innerText = radius;
        
        if (isCircleMode && currentCircleCenter) {
            performCircleAnalysis(currentCircleCenter, radius);
        }
    });

    // 启动应用
    initApp();

</script>
</body>
</html>
